<div *ngIf="loading" class="loading">
  Loading Marketplace...
</div>

<div *ngIf="!loading">

  <h1>ðŸŒ¾ Marketplace</h1>
  <p>Buy fresh products directly from farmers</p>

  <!-- FILTER BAR -->
  <!-- FILTER BAR -->
<div class="filters">
  <input
    type="text"
    placeholder="Search crop..."
    [value]="search"
    (input)="search=$any($event.target).value; applyFilters()"
    class="filter-input"
  />

  <input
    type="number"
    placeholder="Min â‚¹"
    [value]="minPrice"
    (input)="minPrice=$any($event.target).valueAsNumber; applyFilters()"
    class="filter-input"
  />

  <input
    type="number"
    placeholder="Max â‚¹"
    [value]="maxPrice"
    (input)="maxPrice=$any($event.target).valueAsNumber; applyFilters()"
    class="filter-input"
  />

  <select
    [value]="sortBy"
    (change)="sortBy=$any($event.target).value; applyFilters()"
    class="filter-input"
  >
    <option value="">Sort</option>
    <option value="PRICE_ASC">Price â†‘</option>
    <option value="PRICE_DESC">Price â†“</option>
    <option value="QTY_ASC">Qty â†‘</option>
    <option value="QTY_DESC">Qty â†“</option>
  </select>
</div>


  <!-- PRODUCTS GRID -->
  <div class="grid">
    <div class="card" *ngFor="let p of filteredProducts">
      <img [src]="p.cropImageUrl" [alt]="p.cropName" />

      <h3>{{ p.cropName }}</h3>
      <p>â‚¹{{ p.price }} / kg</p>
      <p>Available: {{ p.quantity }} kg</p>
      <p>Grade: {{ p.qualityGrade }}</p>
      <p>Location: {{ p.location }}</p>
<button (click)="buyNow(p)" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px;">
  Buy Now
</button>

      <button class="cart-btn" (click)="addToCart(p)">ðŸ›’ Add to Cart</button>
      <button class="trace-btn" (click)="openTrace(p.traceUrl)">ðŸŒ± Trace Origin</button>
    </div>
  </div>
</div>

<!-- CHECKOUT MODAL -->
<div class="modal" *ngIf="selectedProduct">
  <form [formGroup]="checkoutForm">
    <h2>Checkout</h2>

    <input type="number" formControlName="quantity" placeholder="Quantity (kg)" />
    <textarea formControlName="address" placeholder="Delivery Address"></textarea>
    <input type="text" formControlName="contact" placeholder="10-digit mobile number" />

    <p>Total: â‚¹{{ (checkoutForm.value?.quantity ?? 0) * (selectedProduct?.price ?? 0) }}</p>

    <button type="button" (click)="placeOrder()" [disabled]="checkoutForm.invalid">
      Place Order
    </button>
    <button type="button" (click)="closeCheckout()">Cancel</button>
  </form>
</div>
