<h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
  ðŸ‘¤ Users
</h2>

<!-- ================= FILTER BAR ================= -->
<div class="flex flex-wrap gap-4 mb-6 items-center">

  <!-- SEARCH -->
  <input
    type="text"
    placeholder="Search users..."
    class="px-4 py-2 border rounded-lg w-64"
    (input)="search = $any($event.target).value"
  />

  <!-- STATUS FILTER -->
  <select
    class="px-3 py-2 border rounded-lg"
    (change)="statusFilter = $any($event.target).value"
  >
    <option value="ALL">All Status</option>
    <option value="ACTIVE">Active</option>
    <option value="INACTIVE">Inactive</option>
  </select>

  <!-- ROLE FILTER -->
  <select
    class="px-3 py-2 border rounded-lg"
    (change)="roleFilter = $any($event.target).value"
  >
    <option value="ALL">All Roles</option>
    <option value="FARMER">Farmer</option>
    <option value="DISTRIBUTOR">Distributor</option>
    <option value="BUYER">Buyer</option>
    <option value="ADMIN">Admin</option>
  </select>
</div>

<div *ngIf="loading" class="text-gray-500">Loading users...</div>

<!-- ================= USERS TABLE ================= -->
<table *ngIf="!loading" class="w-full bg-white rounded shadow">
  <thead class="bg-gray-100">
    <tr>
      <th class="p-3 text-left">Name</th>
      <th class="p-3 text-left">Email</th>
      <th class="p-3 text-left">Role</th>
      <th class="p-3 text-left">Status</th>
      <th class="p-3 text-right">Actions</th>
    </tr>
  </thead>

  <tbody>
    <tr *ngFor="let u of filteredUsers" class="border-t hover:bg-gray-50">

      <!-- NAME + ROLE BADGE -->
      <td class="p-3">
        <div class="flex items-center gap-2">
          <span class="font-medium text-gray-900">
            {{ u.name || u.fullName }}
          </span>

          <span
            class="px-2 py-0.5 text-xs font-semibold rounded-full"
            [ngClass]="{
              'bg-green-100 text-green-700': u.role === 'FARMER',
              'bg-blue-100 text-blue-700': u.role === 'DISTRIBUTOR',
              'bg-purple-100 text-purple-700': u.role === 'BUYER',
              'bg-red-100 text-red-700': u.role === 'ADMIN'
            }"
          >
            {{ u.role }}
          </span>
        </div>
      </td>

      <!-- EMAIL -->
      <td class="p-3">{{ u.email }}</td>

      <!-- ROLE CHANGE -->
      <td class="p-3">
        <select
          #roleSelect
          [value]="u.role"
          (change)="pendingRoleChange = { user: u, role: roleSelect.value }"
          class="border rounded px-2 py-1 text-sm bg-white"
        >
          <option *ngFor="let r of ['FARMER','DISTRIBUTOR','BUYER','ADMIN']"
                  [value]="r">
            {{ r }}
          </option>
        </select>
      </td>

      <!-- STATUS -->
      <td class="p-3">
        <span
          class="px-3 py-1 rounded-full text-xs"
          [ngClass]="u.blocked
            ? 'bg-red-100 text-red-700'
            : 'bg-green-100 text-green-700'">
          {{ u.blocked ? 'Inactive' : 'Active' }}
        </span>
      </td>

      <!-- ACTIONS -->
      <td class="p-3 text-right">
        <button
          *ngIf="!u.blocked"
          (click)="blockUser(u.id)"
          class="text-red-600 hover:underline">
          Block
        </button>

        <button
          *ngIf="u.blocked"
          (click)="unblockUser(u.id)"
          class="text-blue-600 hover:underline">
          Unblock
        </button>
      </td>
    </tr>
  </tbody>
</table>

<!-- ================= CONFIRM MODAL ================= -->
<div *ngIf="pendingRoleChange"
     class="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-[360px]">
    <h3 class="text-lg font-semibold mb-4">
      Change role to {{ pendingRoleChange.role }}?
    </h3>

    <div class="flex justify-end gap-3">
      <button
        (click)="pendingRoleChange = null"
        class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">
        Cancel
      </button>

      <button
        (click)="confirmRoleChange()"
        class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
        Confirm
      </button>
    </div>
  </div>
</div>
