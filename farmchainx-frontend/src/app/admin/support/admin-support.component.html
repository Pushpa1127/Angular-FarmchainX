<h1 class="text-3xl font-bold mb-6">ðŸŽ§ Support Ticket Management</h1>

<!-- ================= STATS ================= -->
<div *ngIf="stats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
  <div class="bg-blue-50 p-4 rounded-xl shadow">
    <div class="text-2xl font-bold">{{ stats.totalTickets || 0 }}</div>
    <div class="text-sm text-blue-600">Total Tickets</div>
  </div>

  <div class="bg-red-50 p-4 rounded-xl shadow">
    <div class="text-2xl font-bold">{{ stats.openTickets || 0 }}</div>
    <div class="text-sm text-red-600">Open</div>
  </div>

  <div class="bg-yellow-50 p-4 rounded-xl shadow">
    <div class="text-2xl font-bold">{{ stats.inProgressTickets || 0 }}</div>
    <div class="text-sm text-yellow-600">In Progress</div>
  </div>

  <div class="bg-green-50 p-4 rounded-xl shadow">
    <div class="text-2xl font-bold">{{ stats.resolvedTickets || 0 }}</div>
    <div class="text-sm text-green-600">Resolved</div>
  </div>
</div>

<!-- ================= MAIN ================= -->
<div class="flex flex-col lg:flex-row gap-6">

  <!-- ================= LEFT ================= -->
  <div class="lg:w-1/3">
    <div class="bg-white rounded-xl shadow flex flex-col h-[650px]">

      <!-- Tabs -->
      <div class="flex gap-2 p-4 border-b bg-gray-50 overflow-x-auto">
        <button
          *ngFor="let t of tabs"
          (click)="setTab(t)"
          class="px-4 py-1.5 rounded-full text-sm font-medium border"
          [ngClass]="{
            'bg-blue-600 text-white border-blue-600': activeTab === t,
            'bg-white text-gray-700 border-gray-200 hover:bg-gray-100': activeTab !== t
          }">
          {{ t }}
        </button>
      </div>

      <!-- Ticket List -->
      <div class="flex-1 overflow-y-auto">
        <div
          *ngFor="let t of filteredTickets"
          (click)="selectTicket(t)"
          class="p-4 border-b cursor-pointer hover:bg-gray-50"
          [class.bg-blue-50]="selectedTicket?.id === t.id">

          <h3 class="font-semibold truncate">{{ t.subject }}</h3>
          <p class="text-sm text-gray-600 truncate">{{ t.description }}</p>

          <div class="text-xs text-gray-500 mt-1">
            #{{ t.ticketId }} â€¢ {{ t.status }}
          </div>

          <div *ngIf="t.issueType === 'USER_DISPUTE'"
               class="text-xs text-red-600 font-semibold mt-1">
            âš  User Dispute
          </div>
        </div>

        <div *ngIf="filteredTickets.length === 0"
             class="h-full flex items-center justify-center text-gray-400">
          <p>No tickets found</p>
        </div>
      </div>

    </div>
  </div>

  <!-- ================= RIGHT ================= -->
  <div class="lg:w-2/3">

    <div *ngIf="selectedTicket; else emptyState"
         class="bg-white rounded-xl shadow h-[650px] flex flex-col">

      <!-- Header -->
      <div class="p-6 border-b">
        <h2 class="text-xl font-bold">{{ selectedTicket.subject }}</h2>

        <select
          #statusSelect
          class="mt-3 border rounded-lg px-3 py-1"
          [value]="selectedTicket.status"
          (change)="updateStatus(statusSelect.value)">
          <option value="OPEN">Open</option>
          <option value="IN_PROGRESS">In Progress</option>
          <option value="RESOLVED">Resolved</option>
          <option value="CLOSED">Closed</option>
        </select>
      </div>

      <!-- ================= USER DISPUTE BLOCK ================= -->
      <div *ngIf="selectedTicket.issueType === 'USER_DISPUTE'"
           class="mx-6 mt-4 p-4 rounded-lg border border-red-200 bg-red-50">

        <div class="font-semibold text-red-700 mb-2">âš  User Dispute</div>

        <div class="text-sm">
          <b>Reported By:</b>
          {{ selectedTicket.reportedByRole }} ({{ selectedTicket.reportedById }})
        </div>

        <div class="text-sm mt-1">
          <b>Reported Against:</b>
          {{ selectedTicket.reportedAgainstRole }}
          ({{ selectedTicket.reportedAgainstId }})
        </div>

        <div class="flex gap-3 mt-4">

  <!-- Contact Reported User -->
  <button
    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm"
    (click)="contactReportedUser()">
    ðŸ“© Contact {{ selectedTicket.reportedAgainstRole }}
  </button>

  <!-- Contact Reporter -->
  <button
    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm"
    (click)="contactReporter()">
    ðŸ“© Contact {{ selectedTicket.reportedByRole }}
  </button>

</div>

      </div>

      <!-- Messages -->
      <div class="flex-1 p-6 space-y-4 overflow-y-auto bg-gray-50">
        <div
          *ngFor="let m of visibleMessages"
          class="p-4 rounded-lg max-w-[80%]"
          [class.ml-auto]="m.senderRole === 'ADMIN'"
          [class.bg-blue-100]="m.senderRole === 'ADMIN'"
          [class.bg-white]="m.senderRole !== 'ADMIN'">

          <div class="text-xs font-semibold mb-1">
            {{ m.senderRole }} â€¢ {{ formatDate(m.createdAt) }}
          </div>

          <p class="text-sm">{{ m.message }}</p>
        </div>
      </div>

      <!-- Reply -->
      <div class="p-6 border-t">
        <textarea
          [(ngModel)]="message"
          rows="3"
          class="w-full border rounded-lg p-3 mb-3"
          placeholder="Type response..."></textarea>

        <button
          (click)="sendMessage()"
          class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          Send Response
        </button>
      </div>

    </div>

    <ng-template #emptyState>
      <div class="bg-white rounded-xl shadow h-[650px] flex items-center justify-center text-gray-400">
        <p>Select a ticket to view details</p>
      </div>
    </ng-template>

  </div>
</div>
